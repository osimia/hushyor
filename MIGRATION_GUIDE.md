# Руководство по применению миграций

## Что изменилось

Добавлена новая модель `TaskAttempt` для отслеживания попыток решения задач и начисления очков.

## Шаги для применения изменений

### 1. Создайте миграцию

```bash
python manage.py makemigrations
```

Вы должны увидеть:
```
Migrations for 'core':
  core\migrations\0003_taskattempt.py
    - Create model TaskAttempt
```

### 2. Примените миграцию

```bash
python manage.py migrate
```

Вы должны увидеть:
```
Running migrations:
  Applying core.0003_taskattempt... OK
```

### 3. Проверьте в админ-панели

После применения миграций:
1. Запустите сервер: `python manage.py runserver`
2. Откройте http://127.0.0.1:8000/admin/
3. Войдите как суперпользователь
4. Вы увидите новую модель "Task Attempts"

## Новая функциональность

### Система попыток и очков

**При решении задачи:**
- ❌ **Неправильный ответ** - не показывается правильный ответ, только "Неправильно"
- ✅ **Правильный ответ с 1 попытки** - начисляется 100% очков (сложность × 5)
- ✅ **Правильный ответ со 2+ попытки** - начисляется 50% очков

**Примеры начисления очков:**
- Задача сложности 1: 5 XP (первая попытка) или 2 XP (вторая+)
- Задача сложности 2: 10 XP (первая попытка) или 5 XP (вторая+)
- Задача сложности 5: 25 XP (первая попытка) или 12 XP (вторая+)

### Отображение в интерфейсе

**При правильном ответе:**
```
✅ Правильно! Отличная работа!
   +10 XP (решено с 1 попытки)
```

**При неправильном ответе:**
```
❌ Неправильно
   Попробуйте еще раз! Используйте подсказку или теорию.
   Попытка 2
```

### Отслеживание в админке

В админ-панели теперь можно видеть:
- Сколько попыток сделал пользователь
- Решена ли задача
- Сколько очков заработано
- Когда последний раз пытался решить

## Важные замечания

⚠️ **Для авторизованных пользователей:**
- Система работает только для залогиненных пользователей
- Очки автоматически добавляются в профиль и таблицу лидеров

⚠️ **Повторное решение:**
- После правильного решения задачи (is_solved=True) повторные попытки не начисляют очки
- Счетчик попыток не увеличивается после решения

⚠️ **Миграция существующих данных:**
- Для существующих пользователей записи TaskAttempt создаются автоматически при первой попытке
- Старые данные не затрагиваются

## Тестирование

### 1. Создайте тестового пользователя
```bash
python manage.py createsuperuser
```

### 2. Добавьте задачи через админку
- Создайте Subject (предмет)
- Создайте Topic (тему)
- Добавьте Task (задачу) с difficulty=2

### 3. Протестируйте систему
1. Откройте задачу
2. Введите неправильный ответ → должно показать "Неправильно" без правильного ответа
3. Введите правильный ответ → должно показать "+10 XP (решено с 2 попытки)"
4. Проверьте профиль → XP должен увеличиться
5. Проверьте таблицу лидеров → очки должны обновиться

## Откат изменений (если нужно)

Если что-то пошло не так:

```bash
python manage.py migrate core 0002
```

Это откатит миграцию TaskAttempt.
