import json
import re

def clean_text(text):
    """
    –ê–∫–∫—É—Ä–∞—Ç–Ω–æ –æ—á–∏—â–∞–µ—Ç —Ç–µ–∫—Å—Ç –æ—Ç –º—É—Å–æ—Ä–Ω—ã—Ö —Å–∏–º–≤–æ–ª–æ–≤ –ø–∞—Ä—Å–∏–Ω–≥–∞ PDF,
    —Å–æ—Ö—Ä–∞–Ω—è—è –≤–µ—Å—å —Å–º—ã—Å–ª–æ–≤–æ–π –∫–æ–Ω—Ç–µ–∫—Å—Ç.
    """
    if not text:
        return text
    
    cleaned = text
    
    # 1. –£–¥–∞–ª—è–µ–º –º—É—Å–æ—Ä–Ω—ã–µ —Å–∏–º–≤–æ–ª—ã –≤ –∫–æ–Ω—Ü–µ —Å—Ç—Ä–æ–∫ (–∞—Ä—Ç–µ—Ñ–∞–∫—Ç—ã –ø–∞—Ä—Å–∏–Ω–≥–∞)
    # –ü–∞—Ç—Ç–µ—Ä–Ω—ã —Ç–∏–ø–∞: "—Å–ª–æ–≤–æ t" –∏–ª–∏ "—Å–ª–æ–≤–æ c" –∏–ª–∏ "—Å–ª–æ–≤–æ j" –≤ –∫–æ–Ω—Ü–µ —Å—Ç—Ä–æ–∫–∏
    cleaned = re.sub(r'\s+[tjcnw]\s*$', '', cleaned, flags=re.MULTILINE)
    cleaned = re.sub(r'\s+[tjcnw]\s*\n', '\n', cleaned)
    
    # 2. –£–¥–∞–ª—è–µ–º –ø–∞—Ç—Ç–µ—Ä–Ω "–ù ." (—á–∞—Å—Ç–æ –≤—Å—Ç—Ä–µ—á–∞–µ—Ç—Å—è –∫–∞–∫ –∞—Ä—Ç–µ—Ñ–∞–∫—Ç)
    cleaned = re.sub(r'\s*–ù\s*\.\s*', ' ', cleaned)
    
    # 3. –£–¥–∞–ª—è–µ–º –ø–∞—Ç—Ç–µ—Ä–Ω "! n" 
    cleaned = re.sub(r'!\s*n\s*', '', cleaned)
    
    # 4. –£–¥–∞–ª—è–µ–º –æ–¥–∏–Ω–æ—á–Ω—ã–µ –ª–∞—Ç–∏–Ω—Å–∫–∏–µ –±—É–∫–≤—ã –≤ –æ—Ç–¥–µ–ª—å–Ω—ã—Ö —Å—Ç—Ä–æ–∫–∞—Ö
    # (–Ω–æ –ù–ï —Ç—Ä–æ–≥–∞–µ–º –∏—Ö –≤–Ω—É—Ç—Ä–∏ —Å–ª–æ–≤ –∏–ª–∏ –≤ –∫–æ–Ω—Ç–µ–∫—Å—Ç–µ)
    cleaned = re.sub(r'\n\s*[tjcnw]\s*\n', '\n', cleaned)
    cleaned = re.sub(r'\n\s*[–û–ì–ô–†–î]\s*\n', '\n', cleaned)
    
    # 4.1. –£–¥–∞–ª—è–µ–º –ª–∞—Ç–∏–Ω—Å–∫–∏–µ –±—É–∫–≤—ã –≤–Ω—É—Ç—Ä–∏ —Ç–∞–¥–∂–∏–∫—Å–∫–∏—Ö —Å–ª–æ–≤ (–∞—Ä—Ç–µ—Ñ–∞–∫—Ç—ã –ø–∞—Ä—Å–∏–Ω–≥–∞)
    # –£–¥–∞–ª—è–µ–º –æ–¥–∏–Ω–æ—á–Ω—ã–µ –∑–∞–≥–ª–∞–≤–Ω—ã–µ –ª–∞—Ç–∏–Ω—Å–∫–∏–µ –±—É–∫–≤—ã –º–µ–∂–¥—É –∫–∏—Ä–∏–ª–ª–∏—á–µ—Å–∫–∏–º–∏
    # –ü–∞—Ç—Ç–µ—Ä–Ω—ã —Ç–∏–ø–∞: "–∫–∞–ª–∏–û–º–∞–∏" -> "–∫–∞–ª–∏–º–∞–∏", "—Å–∏—Ñ–∞—Ç—Å–û–æ–∑" -> "—Å–∏—Ñ–∞—Ç—Å–æ–∑"
    
    # –£–¥–∞–ª—è–µ–º –∑–∞–≥–ª–∞–≤–Ω—ã–µ –ª–∞—Ç–∏–Ω—Å–∫–∏–µ –±—É–∫–≤—ã –º–µ–∂–¥—É —Å—Ç—Ä–æ—á–Ω—ã–º–∏ –∫–∏—Ä–∏–ª–ª–∏—á–µ—Å–∫–∏–º–∏
    cleaned = re.sub(r'([–∞-—è—ë”£”Ø“õ“ì“≥“∑])O([–∞-—è—ë”£”Ø“õ“ì“≥“∑])', r'\1\2', cleaned)
    cleaned = re.sub(r'([–∞-—è—ë”£”Ø“õ“ì“≥“∑])–†([–∞-—è—ë”£”Ø“õ“ì“≥“∑])', r'\1\2', cleaned)
    cleaned = re.sub(r'([–∞-—è—ë”£”Ø“õ“ì“≥“∑])C([–∞-—è—ë”£”Ø“õ“ì“≥“∑])', r'\1\2', cleaned)
    cleaned = re.sub(r'([–∞-—è—ë”£”Ø“õ“ì“≥“∑])–ê([–∞-—è—ë”£”Ø“õ“ì“≥“∑])', r'\1\2', cleaned)
    cleaned = re.sub(r'([–∞-—è—ë”£”Ø“õ“ì“≥“∑])–í([–∞-—è—ë”£”Ø“õ“ì“≥“∑])', r'\1\2', cleaned)
    cleaned = re.sub(r'([–∞-—è—ë”£”Ø“õ“ì“≥“∑])–ï([–∞-—è—ë”£”Ø“õ“ì“≥“∑])', r'\1\2', cleaned)
    cleaned = re.sub(r'([–∞-—è—ë”£”Ø“õ“ì“≥“∑])–ù([–∞-—è—ë”£”Ø“õ“ì“≥“∑])', r'\1\2', cleaned)
    cleaned = re.sub(r'([–∞-—è—ë”£”Ø“õ“ì“≥“∑])–ö([–∞-—è—ë”£”Ø“õ“ì“≥“∑])', r'\1\2', cleaned)
    cleaned = re.sub(r'([–∞-—è—ë”£”Ø“õ“ì“≥“∑])–ú([–∞-—è—ë”£”Ø“õ“ì“≥“∑])', r'\1\2', cleaned)
    cleaned = re.sub(r'([–∞-—è—ë”£”Ø“õ“ì“≥“∑])–¢([–∞-—è—ë”£”Ø“õ“ì“≥“∑])', r'\1\2', cleaned)
    cleaned = re.sub(r'([–∞-—è—ë”£”Ø“õ“ì“≥“∑])–•([–∞-—è—ë”£”Ø“õ“ì“≥“∑])', r'\1\2', cleaned)
    
    # –£–¥–∞–ª—è–µ–º —Ç–æ—á–∫—É –ø–æ—Å–ª–µ –ª–∞—Ç–∏–Ω—Å–∫–∏—Ö –±—É–∫–≤ –≤ –≤–∞—Ä–∏–∞–Ω—Ç–∞—Ö –æ—Ç–≤–µ—Ç–æ–≤
    cleaned = re.sub(r'([–∞-—è—ë”£”Ø“õ“ì“≥“∑])\s*\.\s*([–∞-—è—ë”£”Ø“õ“ì“≥“∑])', r'\1\2', cleaned)
    
    # 5. –£–¥–∞–ª—è–µ–º –æ–¥–∏–Ω–æ—á–Ω—ã–µ –±—É–∫–≤—ã –≤ –∫–æ–Ω—Ü–µ –ø–æ—Å–ª–µ –ø–µ—Ä–µ–Ω–æ—Å–∞ —Å—Ç—Ä–æ–∫–∏
    cleaned = re.sub(r'\n\s*[–∞-—è–ê-–Ø—ë–Å”£”¢”Ø”Æ“õ“ö“ì“í“≥“≤“∑“∂]\s*$', '', cleaned)
    
    # 6. –£–¥–∞–ª—è–µ–º —Å—Ç—Ä–æ–∫–∏ —Å–æ—Å—Ç–æ—è—â–∏–µ —Ç–æ–ª—å–∫–æ –∏–∑ –æ–¥–∏–Ω–æ—á–Ω—ã—Ö –±—É–∫–≤/—Å–∏–º–≤–æ–ª–æ–≤
    lines = cleaned.split('\n')
    cleaned_lines = []
    for line in lines:
        # –ü—Ä–æ–ø—É—Å–∫–∞–µ–º —Å—Ç—Ä–æ–∫–∏ –∏–∑ 1-2 —Å–∏–º–≤–æ–ª–æ–≤ (–∫—Ä–æ–º–µ –æ—Å–º—ã—Å–ª–µ–Ω–Ω—ã—Ö)
        stripped = line.strip()
        if len(stripped) <= 2 and stripped not in ['–ê)', '–í)', '–°)', '–î)', 'A)', 'B)', 'C)', 'D)']:
            # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–µ —è–≤–ª—è–µ—Ç—Å—è –ª–∏ —ç—Ç–æ —á–∞—Å—Ç—å—é —Ç–µ–∫—Å—Ç–∞
            if stripped.lower() in ['j', 't', 'c', 'n', 'w', '–æ', '–≥', '–π', '—Ä', '–¥', '–Ω', '–º', '—Å', '–∞', '–∏']:
                continue
        cleaned_lines.append(line)
    
    cleaned = '\n'.join(cleaned_lines)
    
    # 7. –£–¥–∞–ª—è–µ–º –Ω–æ–º–µ—Ä–∞ —Å—Ç—Ä–∞–Ω–∏—Ü –∏–∑ PDF (–∞—Ä—Ç–µ—Ñ–∞–∫—Ç—ã –ø–∞—Ä—Å–∏–Ω–≥–∞)
    # –ü–∞—Ç—Ç–µ—Ä–Ω: "–ó–∞–±–æ–Ω–∏ —Ç–æ“∑–∏–∫”£ (–∏–º—Ç–∏“≥–æ–Ω–∏ “õ–∏—Å–º“≥–æ–∏ –ê –≤–∞ –ë –±–∞—Ä–æ–∏ –ò–ú–î 2025) –°–∞“≥–∏—Ñ–∞–∏ X"
    cleaned = re.sub(r'–ó–∞–±–æ–Ω–∏ —Ç–æ“∑–∏–∫”£ \(–∏–º—Ç–∏“≥–æ–Ω–∏ “õ–∏—Å–º“≥–æ–∏ –ê –≤–∞ –ë –±–∞—Ä–æ–∏ –ò–ú–î \d+\) –°–∞“≥–∏—Ñ–∞–∏ \d+', '', cleaned)
    
    # 8. –£–¥–∞–ª—è–µ–º –º–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã–µ –ø—Ä–æ–±–µ–ª—ã –∏ –ø–µ—Ä–µ–Ω–æ—Å—ã —Å—Ç—Ä–æ–∫
    cleaned = re.sub(r'\n\s*\n\s*\n+', '\n\n', cleaned)  # –ú–∞–∫—Å–∏–º—É–º 2 –ø–µ—Ä–µ–Ω–æ—Å–∞ –ø–æ–¥—Ä—è–¥
    cleaned = re.sub(r' +', ' ', cleaned)  # –ú–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã–µ –ø—Ä–æ–±–µ–ª—ã
    cleaned = cleaned.strip()
    
    return cleaned

def clean_database(input_file, output_file):
    """
    –û—á–∏—â–∞–µ—Ç –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö —Ç–µ—Å—Ç–æ–≤ –æ—Ç –º—É—Å–æ—Ä–Ω—ã—Ö —Å–∏–º–≤–æ–ª–æ–≤
    """
    print(f"üìñ –ß–∏—Ç–∞—é —Ñ–∞–π–ª: {input_file}")
    
    with open(input_file, 'r', encoding='utf-8') as f:
        data = json.load(f)
    
    print(f"üìä –í—Å–µ–≥–æ –≤–æ–ø—Ä–æ—Å–æ–≤: {len(data)}")
    
    cleaned_count = 0
    
    for question in data:
        # –û—á–∏—â–∞–µ–º —Ç–µ–∫—Å—Ç –≤–æ–ø—Ä–æ—Å–∞
        original_question = question['question_text']
        question['question_text'] = clean_text(original_question)
        
        if original_question != question['question_text']:
            cleaned_count += 1
        
        # –û—á–∏—â–∞–µ–º –≤–∞—Ä–∏–∞–Ω—Ç—ã –æ—Ç–≤–µ—Ç–æ–≤
        for key, value in question['options'].items():
            original_option = value
            question['options'][key] = clean_text(value)
            
            if original_option != question['options'][key]:
                cleaned_count += 1
    
    # –°–æ—Ö—Ä–∞–Ω—è–µ–º –æ—á–∏—â–µ–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
    with open(output_file, 'w', encoding='utf-8') as f:
        json.dump(data, f, ensure_ascii=False, indent=4)
    
    print(f"‚úÖ –û—á–∏—Å—Ç–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞!")
    print(f"üßπ –û—á–∏—â–µ–Ω–æ —ç–ª–µ–º–µ–Ω—Ç–æ–≤: {cleaned_count}")
    print(f"üíæ –°–æ—Ö—Ä–∞–Ω–µ–Ω–æ –≤: {output_file}")
    
    # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø—Ä–∏–º–µ—Ä –æ—á–∏—â–µ–Ω–Ω–æ–≥–æ –≤–æ–ø—Ä–æ—Å–∞
    print("\nüìù –ü—Ä–∏–º–µ—Ä –æ—á–∏—â–µ–Ω–Ω–æ–≥–æ –≤–æ–ø—Ä–æ—Å–∞:")
    print(f"ID: {data[0]['id']}")
    print(f"–í–æ–ø—Ä–æ—Å: {data[0]['question_text']}")
    print(f"–í–∞—Ä–∏–∞–Ω—Ç—ã:")
    for key, value in data[0]['options'].items():
        print(f"  {key}: {value}")

if __name__ == "__main__":
    clean_database("test_database.json", "test_database_clean.json")
